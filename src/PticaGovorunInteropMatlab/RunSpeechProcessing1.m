w1=[68,148,-28,25,71,118,332,672,1036,1772,2051,2380,2461,2316,2232,1914,1201,701,562,214,406,420,782,809,980,1490,1159,1421,1658,1606,1815,2119,2144,2059,2163,2029,1883,1840,1993,1655,1741,1684,2047,1846,1206,1759,744,589,621,261,-166,95,404,139,1016,870,1246,1567,1732,2247,2230,2120,2574,2009,1625,1383,990,229,-408,24,-1154,-492,-569,-871,-197,-848,-63,48,482,2537,4118,5579,8144,8863,9864,10997,10609,10550,9924,8260,6591,4087,792,-502,-3484,-4999,-5572,-7004,-6191,-5805,-3953,-2060,116,3053,4921,6356,6924,7605,7371,6738,6624,5846,4889,3682,3179,1895,629,335,-653,-691,-1000,-1223,-222,-827,-277,375,208,812,298,113,-691,-1723,-1564,-2237,-2380,-1553,-1308,-1079,-49,432,560,1451,1873,2693,3353,3702,4438,4048,3793,3740,2669,1945,771,-314,-883,-1590,-1191,-869,-403,249,865,1459,1926,2621,2905,3094,3094,3335,2830,1936,1594,228,-691,-1438,-2412,-2879,-2937,-2649,-2028,-1031,-112,799,1574,2053,2547,3070,3199,2934,2576,1864,1048,405,-384,-809,-966,-1290,-1222,-1276,-1072,-417,336,1113,1782,2132,2229,2320,2556,2396,2287,2422,2235,1946,1888,1707,1219,1248,770,695,498,372,238,637,985,1163,2183,1902,2252,2639,2164,2085,2087,1534,1019,943,575,-458,-47,-299,-921,-60,-546,434,44,870,1291,982,2234,1314,2107,1188,817,173,-757,-1211,-884,-86,44,2849,3356,6471,9297,11761,14742,16760,17924,16196,14879,10041,5818,1264,-3464,-7098,-10164,-10937,-11696,-9867,-8766,-5699,-2461,-586,2155,4066,5608,7094,8913,9530,10390,10117,9063,7461,4804,2795,619,-1671,-2501,-2919,-3189,-2461,-2035,-1273,-772,-487,108,-631,-512,-702,-1070,-683,-1248,-1137,-1517,-2309,-3149,-3429,-4086,-4335,-3112,-2631,-706,1155,2839,4363,5103,5788,5931,5595,5163,4587,3809,2899,2001,1500,393,-354,-1186,-2171,-2239,-2087,-1368,-299,968,2193,3484,4302,4439,4256,3355,2400,1596,726,39,-708,-1027,-1120,-1435,-857,-1023,-855,-120,550,1496,2231,3064,3387,3411,3017,2231,1478,395,-570,-1385,-2348,-2676,-2642,-2064,-1464,-602,199,693,1376,1710,2106,2521,2780,3147,3499,3423,3080,2782,2235,1526,731,78,-633,-1290,-1602,-1877,-1654,-1286,-911]';
plot(w1)

% apply pre-empasis
x = [1 3 2 2 6 1]';
y1 = PreEmphasis(x, 0.9);
plot(1:length(x), x, 'r', 1:length(x), y1, 'b')
y2 = PreEmphasis(x, 1);
hold on, plot(1:length(x), y2, 'g'), hold off

s2 = PreEmphasis(w1, 0.97);
plot(w1,'b')
hold on
plot(s2,'r')
hold off

w1Smooth = smooth(w1, 5);
s3 = PreEmphasis(w1Smooth, 0.97);
plot(reshape(w1Smooth,1,[]), 'b-')
hold on
plot(s3, 'r')
hold off

% Hamming window
hamWnd=hamming(400);
sHam = hamWnd .* s2;

ff = fft(sHam, 512);
ffRe = real(ff);
ffIm = imag(ff);
ffAb = abs(ff);
plot(ffAb(1:256))

r1=[8165.38477,-4186.51465,3042.43628,-2750.18018,966.880859,-3723.41846,4820.08301,-2347.57031,7673.41016,-10280.5840,5192.48877,-1072.35400,-1803.46887,-8216.49609,18699.4199,-6784.38428,15082.3340,-43582.0742,28386.3887,-15524.8232,51526.6875,-44898.8711,21996.5332,-40609.8477,15410.2676,17939.9980,16672.7129,-29538.8125,-10841.7529,19996.5645,-10625.9590,18204.2383,-16233.9033,2880.84766,-9803.29492,11493.0361,-6540.98486,12596.4336,-14720.8105,11136.1143,-13688.2559,14729.8281,-11252.7373,10978.3965,-16621.1172,16640.3594,-2036.90942,-7621.25439,2539.90210,412.479950,4945.99561,-3850.87793,3483.54517,-1981.01990,-1074.44775,-891.162964,2443.65063,-1497.39575,1258.72559,-844.500122,843.006165,656.543274,-2693.58398,-1891.92297,5305.57568,-1642.50061,3122.01440,-7032.51221,2487.89380,1496.43713,84.1820602,-516.116028,2952.84839,-5373.28564,2639.35205,-719.935669,1508.78308,-213.389389,-431.973358,-332.792755,315.936615,-896.774963,1714.05713,-1038.46265,-956.636169,2019.19006,-436.705933,-1279.25562,605.489502,1135.25696,-240.454239,-1777.03027,1099.26917,-858.638428,104.394264,590.384399,-1438.75952,1872.18860,-1183.30469,988.821228,-342.458252,-133.775772,-580.317322,652.430786,-202.843369,1126.76733,-1791.02539,386.506226,100.332901,928.572388,178.727539,512.925842,-1773.34766,708.976318,594.898438,-695.435303,738.323669,20.4464684,-318.845978,-376.261963,540.904602,-564.652954,851.466614,-492.934540,-411.461182,750.033936,31.8924599,579.428772,-1267.70874,-6.54596949,1151.10156,-567.841370,-1149.95374,277.275208,520.827454,1394.61096,-1477.84680,-164.402039,-1119.18542,2572.44312,-709.239380,1246.13611,-3218.72754,-665.823303,5829.46387,-1358.86072,-5915.50537,219.326553,4502.50879,1100.28040,-619.965088,768.165466,1371.18335,-4523.78125,1726.73511,-2251.57739,2452.33521,-2049.93970,1566.99744,-2320.14673,5282.08984,-6577.51904,2464.62524,1868.38171,156.824326,-1594.81128,-1641.99377,5175.67432,-6702.79639,5048.82910,-3080.56323,2208.32227,3295.54248,-3911.16431,-529.340271,3735.64087,-3272.82520,1789.99304,-3309.89551,-591.680176,-2597.38989,8310.16797,-533.879517,4538.52588,-9644.04785,792.970154,957.504700,1014.83557,997.483643,1581.10254,2843.10034,-10714.4551,-3048.78320,13766.3145,-404.468781,-3324.21924,-4604.05664,1266.27112,-87.4682312,456.495392,707.198364,-555.071045,3199.52344,-4876.89941,2799.21362,-4831.66504,7298.16260,-4772.42725,1991.99402,-1266.16858,9313.10059,-6321.99561,-5034.51807,-4883.02002,8469.82129,4074.79492,-8025.56885,7329.67285,-9445.59961,10038.7500,-7332.48877,6790.59473,-10790.1406,10162.9893,-9749.35254,12069.7666,-12113.9590,12450.6133,-16311.7725,16493.6738,-9064.75000,10429.8701,-9551.03418,5215.48486,-7985.06152,4839.47412,-923.607483,1002.68573,1344.63062,-1849.43726,845.950378,-1016.84277,261.859009,556.125183,-884.352417,200.825470,-474.238556,614.597168,-94.7040176,-175.649628,-139.004578,319.085449,-478.631409,292.526062,-562.709290,253.124725]';
r2=[0.000000000,-3263.61523,1184.49304,-3242.93262,2937.05981,-1782.89465,3921.97266,-827.457947,-3664.82178,-1021.19043,4490.51172,-7672.24902,7602.26123,-5720.37109,21705.7207,-27327.1016,2640.69824,-5059.94873,19630.1563,12278.1904,-20983.7285,-8346.60547,-11078.9219,19048.7891,-11852.2666,69514.4297,-103992.758,50728.5313,-18630.4863,29785.9121,-26723.5840,24002.6387,-33616.6563,23543.2227,-9807.63379,13865.0820,-8614.52930,3552.14282,-6760.58252,6107.61572,-3661.83398,5966.15479,-4438.43213,-339.554016,4333.30811,-2154.91626,5933.75244,-17424.7793,18814.3379,-5792.08203,218.432343,-1283.92688,1097.22644,-3943.19775,1617.03125,1648.71851,-379.687561,-891.304199,1294.82861,-1746.45801,2049.23413,-3398.06738,1293.75916,508.348602,4479.86328,-5376.06787,1259.04663,-4479.64453,7482.87109,-2166.34326,-908.740784,1267.17505,-2803.12183,517.999207,1733.01233,-231.633743,228.850800,-1037.58655,-193.133911,370.601746,-286.175751,516.501831,-2.33810949,-774.198730,853.278259,-53.3132935,-364.111206,-882.101440,1804.22314,-279.580841,-2515.30054,1605.31995,198.901398,-827.108215,1146.49329,-406.086548,240.839371,436.375946,-179.291748,-44.6186752,-465.256897,205.184860,396.867493,-395.100525,1050.37476,-1159.87695,-80.7660370,573.855164,1152.77576,-1039.32568,1383.15198,-3227.51050,2277.65405,-881.848511,1067.24963,-982.498474,634.421143,-693.746399,-72.2144394,394.819977,-333.779907,462.344543,-240.776459,-167.605957,-18.6041431,846.362976,-775.439331,-83.4274826,-955.919189,1641.34766,-698.973206,-956.782776,836.936401,-58.8614388,1866.24597,-2029.40332,-323.691986,-56.8521729,1999.22595,-690.508118,565.233704,-3511.50000,2583.70068,481.632660,2390.01465,-6510.60010,-523.397644,8700.55957,-2971.89136,1338.13184,-4466.46387,4431.09424,-6918.59961,2910.65454,-1265.74512,2477.11084,-941.666565,-277.462219,882.829590,686.174561,-983.505249,-1937.75110,4249.82471,-489.369995,-2725.90259,526.279053,809.114136,938.662598,-3382.62842,5837.94238,-6788.15430,11198.2646,-13348.3174,8310.60938,-5952.97803,6122.26709,-6740.20313,2956.85620,-1839.54138,1135.89636,4648.00537,1990.70703,-3152.42285,-5239.88184,-1655.64465,4185.22510,1645.87341,-306.674438,-572.423279,2533.34790,-10850.2236,4301.02002,3940.70410,9802.53418,-15130.2822,720.509766,350.958557,3333.96875,-1095.24902,2483.12036,-2521.06152,3482.42163,-4910.84521,2863.60303,-2956.93286,5072.18848,-1661.44580,-1044.00781,1788.92126,-10.0423727,2883.92139,-14444.4424,5280.58838,6068.27979,4259.38525,-6778.15088,-39.1784172,1468.03333,-2148.92212,4385.91602,-4807.73730,1979.05347,-3735.34546,8000.30469,-6754.10205,6469.20410,-5733.72803,1685.40344,1294.20923,3105.87671,-2137.05029,-1666.72339,-3370.25049,1756.14868,-1459.95667,4383.66357,-1152.49121,341.155853,-1027.73181,-589.233459,167.898239,-201.650482,494.920349,-40.6740990,-915.440735,722.917114,-0.555892527,537.525024,-942.860535,418.681458,47.3501129,-225.517899,173.508560,-292.885986,211.836624,360.528046]';
rA=sqrt(r1.^2 + r2.^2);
plot(rA)

a1=[rA ffAb(1:256)];

%% Filter Bank
smpRate = 22050;
periodSec = 1/smpRate;

% Julius assigns int type for this
smp_period = floor(periodSec / (100*1e-9)); %Sampling period in 100ns units

% Scaled FFT resolution
fres = 1e7 / (smp_period * 512 * 700); % =const for given sample rate
melFun = @(k) 1127*log(1+k*fres);
melValues=melFun(0:256);
mlo = 0;
mhi = melFun(512/2);

fbank_num=24;
maxChan=fbank_num+1;
cf=linspace(0,mhi,maxChan+1);
cf=cf(2:end); % skip zero to consider only the right border of each bin

%% overlay freq and mel
Mel=@(f) 2595*log10(1+f/700);
MelInv=@(fMel) 700*(10.^(fMel/2595)-1);
plot(ffAb(1:256))
hold on
plot(Mel(ffAb(1:256)),'r')
hold off

[ffAb(111) melFun(ffAb(111))]

%% fix Julius
fftN=512;
freqLow=smpRate/fftN;
freqHigh=smpRate/2;
Q=24; % number of filter banks
kb=@(bankInd) (fftN/smpRate)*MelInv(Mel(freqLow)+bankInd*(Mel(freqHigh)-Mel(freqLow))/(Q+1));
kbMel=@(bankInd) MelInv(Mel(freqLow)+bankInd*(Mel(freqHigh)-Mel(freqLow))/(Q+1));
bankArray = kb(1:Q);
bankArrayMel = kbMel(1:Q);

%% test Julius lifter of MFCC coefficients
lifter=22;
x=1:12;
plot(x,1+(lifter/2)*sin(x*pi/lifter))

%% test Delta
d1 = RateOfChangeWindowed(w1, 1);
d2 = RateOfChangeWindowed(w1, 2);
d3 = RateOfChangeWindowed(w1, 3);
plot(w1,'b') % signal
hold on
%plot(s2,'r') % PreEmphasis
plot(d1,'g') % Delta
%plot(d2,'b') % Delta
plot(d3,'r') % Delta
hold off
